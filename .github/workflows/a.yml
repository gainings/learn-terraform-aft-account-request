name: Create Release PR

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  create-release-pr:
    runs-on: ubuntu-latest
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Git è¨­å®š
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: GitHub CLI ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        run: gh --version

      - name: æœ€æ–°ã®ã‚¿ã‚°ã‚’å–å¾—
        id: get-latest-tag
        run: |
          LATEST_TAG=$(git tag --list --sort=-v:refname '20[0-9][0-9].[0-9][0-9].[0-9][0-9]*' | head -n 1)
          echo "latest_tag=${LATEST_TAG}" >> $GITHUB_ENV

      - name: æ–°ã—ã„ã‚¿ã‚°ã‚’æ±ºå®š (é‡è¤‡å›é¿)
        id: determine-new-tag
        run: |
          TODAY=$(date -u +"%Y.%m.%d")
          BASE_TAG="$TODAY"

          # æ—¢å­˜ã®PRãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
          EXISTING_PR=$(gh pr list --state open --search "Release $BASE_TAG" --json headRefName --jq '.[0].headRefName' || true)

          if [ -n "$EXISTING_PR" ]; then
            echo "release_branch=${EXISTING_PR}" >> $GITHUB_ENV
            echo "existing_pr_found=true" >> $GITHUB_ENV
          else
            COUNT=1
            while git rev-parse "$BASE_TAG-$COUNT" >/dev/null 2>&1; do
              COUNT=$((COUNT + 1))
            done

            if git rev-parse "$BASE_TAG" >/dev/null 2>&1; then
              NEW_TAG="$BASE_TAG-$COUNT"
            else
              NEW_TAG="$BASE_TAG"
            fi

            echo "release_branch=release-${NEW_TAG}" >> $GITHUB_ENV
            echo "new_tag=${NEW_TAG}" >> $GITHUB_ENV
            echo "existing_pr_found=false" >> $GITHUB_ENV
          fi

      - name: æ›´æ–°å·®åˆ†ã‚’å–å¾—
        id: get-diff
        run: |
          if [ -n "${{ env.latest_tag }}" ]; then
            git log --pretty=format:"- %h %s" ${{ env.latest_tag }}..HEAD > changes.txt
          else
            git log --pretty=format:"- %h %s" HEAD > changes.txt
          fi

          # æ”¹è¡Œã‚’ä¿®æ­£
          sed -i 's/%0A/\n/g' changes.txt
          echo "commit_log=$(cat changes.txt | sed ':a;N;$!ba;s/\n/%0A/g')" >> $GITHUB_ENV

      - name: ãƒªãƒªãƒ¼ã‚¹ç”¨ãƒ–ãƒ©ãƒ³ãƒã®ä½œæˆã¾ãŸã¯æ›´æ–°
        run: |
          git fetch origin ${{ env.release_branch }} || true

          if [ "${{ env.existing_pr_found }}" == "true" ]; then
            # æ—¢å­˜ã® PR ã‚’æ›´æ–°
            git checkout ${{ env.release_branch }}
            git merge --no-edit main
          else
            # æ–°ã—ã„ PR ã®å ´åˆ
            git checkout -b ${{ env.release_branch }}
          fi

          # versionfile ã®æ›´æ–°
          echo "${{ env.new_tag }}" > versionfile

          # å¤‰æ›´å†…å®¹ã‚’è¡¨ç¤ºã™ã‚‹
          echo "## Changes since last release:" > RELEASE.md
          cat changes.txt >> RELEASE.md

          # æ›´æ–°å†…å®¹ã‚’ã‚³ãƒŸãƒƒãƒˆ
          git add versionfile RELEASE.md
          git commit -m "Prepare release ${{ env.new_tag }}" || true
          git push -f origin ${{ env.release_branch }}

      - name: GitHub Pull Request ã‚’ä½œæˆã¾ãŸã¯æ›´æ–°
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ env.existing_pr_found }}" == "true" ]; then
            # PR ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯æ›´æ–°
            echo "æ—¢å­˜ã® PR ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚"
            gh pr edit "release-${{ env.new_tag }}" \
              --body "### ğŸ†• Release \`${{ env.new_tag }}\`
            #### ğŸ”„ Changes since last release:
            $( echo ${{ env.commit_log }} | 's/%0A/\n/g')"
          else
            # æ–°ã—ã„ PR ã‚’ä½œæˆ
            gh pr create \
              --base main \
              --head "${{ env.release_branch }}" \
              --title "Release ${{ env.new_tag }}" \
              --body "### ğŸ†• Release \`${{ env.new_tag }}\`

            #### ğŸ”„ Changes since last release:
            $( echo ${{ env.commit_log }} | 's/%0A/\n/g')

            Once merged, the actual release will be created automatically. ğŸš€"
          fi
