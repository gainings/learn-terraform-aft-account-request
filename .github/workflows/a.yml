name: Create Release PR

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write  # PR 作成権限を明示的に設定

jobs:
  create-release-pr:
    runs-on: ubuntu-latest
    steps:
      - name: チェックアウト
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # すべてのタグを取得

      - name: 最新のタグを取得
        id: get-latest-tag
        run: |
          LATEST_TAG=$(git tag --list --sort=-v:refname '20[0-9][0-9].[0-9][0-9].[0-9][0-9]*' | head -n 1)
          echo "latest_tag=${LATEST_TAG}" >> $GITHUB_ENV

      - name: 新しいタグを決定
        id: determine-new-tag
        run: |
          TODAY=$(date -u +"%Y.%m.%d")
          TAG_BASE="$TODAY"

          COUNT=$(git tag --list "${TAG_BASE}*" | wc -l)
          if [ "$COUNT" -gt 0 ]; then
            NEW_TAG="${TAG_BASE}-$COUNT"
          else
            NEW_TAG="${TAG_BASE}"
          fi

          echo "new_tag=${NEW_TAG}" >> $GITHUB_ENV
          echo "New tag will be: ${NEW_TAG}"

      - name: リリース用ブランチを作成
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          RELEASE_BRANCH="release-${{ env.new_tag }}"
          git checkout -b "$RELEASE_BRANCH"

          # versionfile を更新
          echo "${{ env.new_tag }}" > versionfile

          # RELEASE.md を更新
          echo "# Release ${{ env.new_tag }}" > RELEASE.md
          echo "## Changes since last release:" >> RELEASE.md
          git log ${{ env.latest_tag }}..HEAD --oneline >> RELEASE.md

          git add versionfile RELEASE.md
          git commit -m "Prepare release ${{ env.new_tag }}"
          git push origin "$RELEASE_BRANCH"

      - name: GitHub Pull Request を作成
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --base main \
            --head "release-${{ env.new_tag }}" \
            --title "Release ${{ env.new_tag }}" \
            --body "This PR updates \`versionfile\` and prepares the release \`${{ env.new_tag }}\`.
                    Once merged, the actual release will be created automatically."
